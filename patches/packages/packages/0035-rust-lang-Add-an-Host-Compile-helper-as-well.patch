From b6d5095efd2a809d040bceb59cbe72d2cb24e37b Mon Sep 17 00:00:00 2001
From: Luca Barbato <lu_zero@gentoo.org>
Date: Thu, 9 Mar 2023 08:49:57 +0100
Subject: [PATCH 5/5] rust-lang: Add an Host/Compile helper as well

Signed-off-by: Luca Barbato <lu_zero@gentoo.org>
(cherry picked from commit 2d3e0da71198c4fa7ec981d3c607df84e13a9417)
---
 lang/rust/maturin/Makefile |  9 ++-------
 lang/rust/rust-package.mk  | 11 +++++++++++
 2 files changed, 13 insertions(+), 7 deletions(-)

diff --git a/lang/rust/maturin/Makefile b/lang/rust/maturin/Makefile
index 0249bf9ad7..c2ed4bcd14 100644
--- a/lang/rust/maturin/Makefile
+++ b/lang/rust/maturin/Makefile
@@ -36,12 +36,7 @@ define Package/maturin
 endef
 
 define Host/Compile
-	( \
-		cd $(HOST_BUILD_DIR) ; \
-		export PATH="$(CARGO_HOME)/bin:$(PATH)" ; \
-		CARGO_HOME=$(CARGO_HOME) \
-		cargo install --path . --root $(HOST_BUILD_DIR) ; \
-	)
+	$(call Host/Compile/Cargo)
 endef
 
 define Package/maturin/description
@@ -51,7 +46,7 @@ endef
 
 define Host/Install
 	$(INSTALL_DIR) $(STAGING_DIR_HOSTPKG)/bin
-	$(INSTALL_BIN) $(HOST_BUILD_DIR)/bin/maturin $(STAGING_DIR_HOSTPKG)/bin/maturin
+	$(INSTALL_BIN) $(HOST_INSTALL_DIR)/bin/maturin $(STAGING_DIR_HOSTPKG)/bin/maturin
 endef
 
 $(eval $(call HostBuild))
diff --git a/lang/rust/rust-package.mk b/lang/rust/rust-package.mk
index 472417a617..54c2aa89ac 100644
--- a/lang/rust/rust-package.mk
+++ b/lang/rust/rust-package.mk
@@ -5,6 +5,17 @@
 rust_mk_path:=$(dir $(lastword $(MAKEFILE_LIST)))
 include $(rust_mk_path)rust-host.mk
 
+# $(1) path to the package
+# $(2) additional arguments to cargo
+define Host/Compile/Cargo
+	( \
+		cd $(HOST_BUILD_DIR) ; \
+		export PATH="$(CARGO_HOME)/bin:$(PATH)" ; \
+		CARGO_HOME=$(CARGO_HOME) CC=$(HOSTCC) \
+			cargo install -v --profile stripped --root $(HOST_INSTALL_DIR) --path "$(if $(strip $(1)),$(strip $(1)),.)" $(2) ; \
+	)
+endef
+
 # $(1) path to the package
 # $(2) additional arguments to cargo
 define Build/Compile/Cargo
-- 
2.39.2

